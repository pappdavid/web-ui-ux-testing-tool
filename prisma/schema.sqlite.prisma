generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tests        Test[]
}

model Test {
  id            String     @id @default(cuid())
  userId        String
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  targetUrl     String
  adminPanelUrl String?
  deviceProfile String     @default("desktop")
  status        String     @default("pending")
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  steps         TestStep[]
  runs          TestRun[]
  adminConfig   String?    // JSON stored as text in SQLite
}

model TestStep {
  id                  String   @id @default(cuid())
  testId              String
  test                Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  orderIndex          Int
  type                String
  selector            String?
  value               String?
  assertionType       String?
  assertionExpected   String?
  meta                String?  // JSON stored as text
  createdAt           DateTime @default(now())
  
  @@index([testId, orderIndex])
}

model TestRun {
  id            String      @id @default(cuid())
  testId        String
  test          Test        @relation(fields: [testId], references: [id], onDelete: Cascade)
  startedAt     DateTime    @default(now())
  finishedAt    DateTime?
  status        String      @default("running")
  deviceProfile String      @default("desktop")
  browserType   String      @default("chromium")
  uxMetrics     String?     // JSON stored as text
  logs          TestLog[]
  adminChecks   AdminCheck[]
  attachments   Attachment[]
  
  @@index([testId])
  @@index([status])
}

model TestLog {
  id        String   @id @default(cuid())
  testRunId String
  testRun   TestRun  @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  timestamp DateTime @default(now())
  level     String
  message   String
  data      String?  // JSON stored as text
  
  @@index([testRunId, timestamp])
}

model AdminCheck {
  id            String   @id @default(cuid())
  testRunId     String
  testRun       TestRun  @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  relatedStepId String?
  mode          String
  endpointOrPath String?
  expected      String?  // JSON stored as text
  actual        String?  // JSON stored as text
  status        String
  details       String?
  createdAt     DateTime @default(now())
  
  @@index([testRunId])
}

model Attachment {
  id        String   @id @default(cuid())
  testRunId String
  testRun   TestRun  @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  type      String
  pathOrUrl String
  createdAt DateTime @default(now())
  
  @@index([testRunId, type])
}

